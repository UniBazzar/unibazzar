%% DynamoDB Listings access pattern (PK/SK + GSIs)
flowchart TB
    subgraph MainTable["ğŸ“‹ Listings Table (Main)"]
        direction TB
        Item["ğŸ”‘ PK = LISTING#{listing_id}<br/>ğŸ”‘ SK = META#{timestamp}<br/><br/>ğŸ“ Attributes:<br/>â€¢ title: 'MacBook Pro 13-inch'<br/>â€¢ description: 'Excellent condition...'<br/>â€¢ owner_id: 'user-123'<br/>â€¢ campus_id: 'university-main'<br/>â€¢ category: 'electronics'<br/>â€¢ price: 120000 (cents)<br/>â€¢ stock: 1<br/>â€¢ status: 'available'<br/>â€¢ views: 42<br/>â€¢ likes: 7<br/>â€¢ media_urls: [...]<br/>â€¢ created_at: ISO timestamp<br/>â€¢ updated_at: ISO timestamp"]
    end

    subgraph GSI1["ğŸ« GSI: campus_idx"]
        direction TB
        G1["ğŸ”‘ PK = campus_id<br/>ğŸ”‘ SK = created_at<br/>ğŸ“Š Projected: ALL<br/><br/>ğŸ¯ Use Case:<br/>Get all listings for a campus<br/>with pagination & time-based sorting"]
    end

    subgraph GSI2["ğŸ·ï¸ GSI: category_idx"]
        G2["ğŸ”‘ PK = category<br/>ğŸ”‘ SK = created_at<br/>ğŸ“Š Projected: ALL<br/><br/>ğŸ¯ Use Case:<br/>Browse listings by category<br/>(electronics, books, furniture, etc.)"]
    end

    subgraph GSI3["ğŸ‘¤ GSI: seller_idx"]
        G3["ğŸ”‘ PK = owner_id<br/>ğŸ”‘ SK = created_at<br/>ğŸ“Š Projected: ALL<br/><br/>ğŸ¯ Use Case:<br/>Get all listings by a specific seller<br/>for profile pages & management"]
    end

    subgraph AccessPatterns["ğŸ” Query Patterns & Performance"]
        direction TB
        
        subgraph Queries["ğŸ“Š Common Query Patterns"]
            Q1["ğŸ” Get Single Listing<br/>GetItem(PK=LISTING#123, SK=META#*)"]
            Q2["ğŸ« Campus Browse<br/>Query campus_idx WHERE PK=campus_id<br/>LIMIT 20, pagination token"]
            Q3["ğŸ·ï¸ Category Browse<br/>Query category_idx WHERE PK=electronics<br/>FilterExpression: price BETWEEN min AND max"]
            Q4["ğŸ‘¤ Seller Profile<br/>Query seller_idx WHERE PK=user-123<br/>ProjectionExpression: title,price,status"]
            Q5["ğŸ“ˆ Popular Items<br/>Scan with FilterExpression: views > 100<br/>OR use separate popularity GSI"]
        end
        
        subgraph Counters["ğŸ“Š Counter Management"]
            C1["âš¡ Atomic Counters<br/>UpdateItem: ADD views 1<br/>For low-frequency updates"]
            C2["ğŸ“¦ Batch Updates<br/>Event-driven counter updates<br/>via Lambda/background job<br/>For high-frequency metrics"]
            C3["ğŸš€ Cached Aggregates<br/>Store popular/trending in Redis<br/>Updated hourly via cron job"]
        end
    end

    %% Query flow connections
    Q1 --> Item
    Q2 --> G1
    Q3 --> G2  
    Q4 --> G3

    %% Counter update flows
    Item -.-> C1
    Item -.-> C2
    C2 -.-> C3

    %% Styling
    classDef table fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000;
    classDef gsi fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000;
    classDef query fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000;
    classDef counter fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000;
    
    class Item table;
    class G1,G2,G3 gsi;
    class Q1,Q2,Q3,Q4,Q5 query;
    class C1,C2,C3 counter;
