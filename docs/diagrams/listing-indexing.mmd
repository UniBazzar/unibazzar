%% Listing creation -> indexing -> recommendation flow
sequenceDiagram
  autonumber
  participant U as ğŸ“± User (Seller)
  participant GW as ğŸšª API Gateway
  participant L as ğŸ“‹ Listing Service
  participant S3 as ğŸ“¦ S3 Media Storage
  participant I as ğŸ“¨ RabbitMQ Events
  participant SI as ğŸ” Search Indexer
  participant AI as ğŸ¤– AI Service
  participant OS as ğŸ” OpenSearch
  participant VDB as ğŸ§  Vector Database
  participant DDB as âš¡ DynamoDB
  participant CACHE as ğŸš€ Redis Cache

  Note over U,CACHE: ğŸ¯ Complete Listing Lifecycle: Create â†’ Index â†’ AI Processing
  
  rect rgba(0, 0, 0, 1)
    Note over U,S3: ğŸ“ Listing Creation Phase
    U->>+GW: ğŸ“‹ POST /listings<br/>{title, description, price, images[]}
    GW->>+L: ğŸ—ï¸ CreateListingCommand
    
    L->>+DDB: ğŸ’¾ Begin transaction
    L->>DDB: Insert listing document<br/>{id, title, desc, seller_id, status: DRAFT}
    
    alt ğŸ“· Has Media Files
      L->>+S3: ğŸ“¤ Generate signed upload URLs<br/>PUT /listings/{id}/media/*
      S3-->>-L: âœ… Signed URLs + media keys
      L->>DDB: ğŸ’¾ Update listing with media_keys[]
      Note right of S3: User uploads directly to S3<br/>using signed URLs (client-side)
      U->>S3: ğŸ“¤ Upload images/videos
      S3-->>U: âœ… Upload complete
    end
    
    L->>DDB: ğŸ’¾ Update status: ACTIVE + commit transaction
    L->>DDB: ğŸ’¾ Write outbox event (listing.created)
    deactivate DDB
    
    L->>+I: ğŸ“¨ Outbox publisher â†’ listing.created
    L->>-GW: âœ… Listing created successfully
    GW->>-U: ğŸ‰ Your listing is live!
  end
  
  Note over I,CACHE: ğŸ”„ Asynchronous Processing Pipeline
  
  par Search Indexing Flow
    I-->>+SI: ğŸ” listing.created event
    SI->>SI: ğŸ—ï¸ Transform to search document<br/>{title, desc, category, price, location}
    SI->>+OS: ğŸ“ Index document<br/>POST /listings/_doc/{listing_id}
    OS-->>-SI: âœ… Indexed successfully
    SI->>CACHE: ğŸš€ Cache search metadata<br/>SET search:listing:{id}
    Note right of SI: Document now searchable<br/>in full-text search
    deactivate SI
    
  and AI Processing Flow
    I-->>+AI: ğŸ¤– listing.created event
    AI->>AI: ğŸ§  Generate text embeddings<br/>using sentence-transformers
    AI->>AI: ğŸ·ï¸ Content moderation check<br/>(inappropriate content detection)
    
    alt âœ… Content Approved
      AI->>+VDB: ğŸ§  Upsert vector embedding<br/>id={listing_id}, vector[384]
      VDB-->>-AI: âœ… Vector stored
      AI->>DDB: ğŸ’¾ Cache embedding metadata<br/>for quick similarity searches
      AI->>I: ğŸ“¨ publish listing.ai_processed<br/>{status: "approved"}
      
    else ğŸš¨ Content Flagged
      AI->>I: ğŸ“¨ publish listing.content_flagged<br/>{reason, confidence}
      Note right of AI: Listing may be auto-hidden<br/>pending manual review
    end
    deactivate AI
    
  and Real-time Updates
    I-->>+CACHE: ğŸš€ Update cached counters
    CACHE->>CACHE: INCR campus:{campus_id}:listing_count
    CACHE->>CACHE: ZADD trending_listings {timestamp} {listing_id}
    deactivate CACHE
  end
  
  rect rgba(0, 0, 0, 1)
    Note over AI,VDB: ğŸ¯ Advanced AI Features (Async)
    
    AI->>AI: ğŸ”„ Trigger recommendation recomputation<br/>for similar users/categories
    AI->>VDB: ğŸ” Find similar listings<br/>using vector similarity search
    AI->>CACHE: ğŸš€ Update recommendation cache<br/>for affected users
    
    Note right of AI: Background job: Update ML models<br/>with new listing data
  end
  
  Note over U,CACHE: ğŸŠ Listing Processing Complete
  Note over U,CACHE: âœ… Searchable âœ… AI-Enhanced âœ… Recommendations Updated
