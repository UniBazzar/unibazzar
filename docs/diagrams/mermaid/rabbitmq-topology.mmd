%% RabbitMQ topology (topic exchange + queues + DLQ)
graph TB
    subgraph Exchanges["ğŸ“¨ Exchanges"]
        EX["ğŸ”„ domain.events<br/>(type: topic, durable: true)<br/>ğŸ¯ Main event routing hub"]
        DLX["ğŸ’€ domain.dlx<br/>(dead-letter exchange)<br/>ğŸš¨ Failed message handling"]
    end

    subgraph ListingQueues["ğŸ“‹ Listing Service Queues"]
        Q1["ğŸ“‹ listing.events.queue<br/>ğŸ”— Binding: listing.*<br/>âš¡ Auto-delete: false<br/>ğŸ¯ Process listing events"]
        Q1R["ğŸ”„ listing.events.retry<br/>â° TTL: 30s â†’ domain.events<br/>ğŸ“ˆ Max retries: 3"]
        Q1P["ğŸ’€ listing.events.poison<br/>ğŸš¨ Manual intervention needed<br/>ğŸ“Š Monitor for failures"]
    end

    subgraph OrderQueues["ğŸ“¦ Order Service Queues"]
        Q2["ğŸ“¦ order.events.queue<br/>ğŸ”— Binding: order.*<br/>ğŸ¯ Process order lifecycle"]
        Q2R["ğŸ”„ order.events.retry<br/>â° TTL: 60s â†’ domain.events<br/>ğŸ“ˆ Exponential backoff"]
        Q2P["ğŸ’€ order.events.poison<br/>ğŸš¨ Dead letter for manual review"]
    end

    subgraph SearchQueues["ğŸ” Search & AI Queues"]
        Q3["ğŸ” search.indexer.queue<br/>ğŸ”— Binding: listing.*, order.completed<br/>ğŸ¯ Update search indices"]
        Q4["ğŸ¤– ai.recommendation.queue<br/>ğŸ”— Binding: listing.*, user.*, order.*<br/>ğŸ¯ ML model updates"]
        Q3R["ğŸ”„ search.retry<br/>â° TTL: 45s"]
        Q4R["ğŸ”„ ai.retry<br/>â° TTL: 120s (ML processing)"]
    end

    subgraph NotificationQueues["ğŸ“¢ Notification Queues"]
        Q5["ğŸ“¢ notifications.queue<br/>ğŸ”— Binding: *.completed, *.confirmed<br/>ğŸ¯ User notifications"]
        Q6["ğŸ“§ email.queue<br/>ğŸ”— Binding: notification.email<br/>ğŸ¯ Email delivery"]
        Q7["ğŸ“± push.queue<br/>ğŸ”— Binding: notification.push<br/>ğŸ¯ Push notifications"]
    end

    subgraph Analytics["ğŸ“Š Analytics & Monitoring"]
        Q8["ğŸ“Š analytics.queue<br/>ğŸ”— Binding: #<br/>ğŸ¯ Capture all events for metrics"]
        Q9["ğŸ” audit.queue<br/>ğŸ”— Binding: *.created, *.updated, *.deleted<br/>ğŸ¯ Audit trail"]
    end

    %% Main event flow
    EX -->|listing.*| Q1
    EX -->|order.*| Q2
    EX -->|listing.*, order.completed| Q3
    EX -->|listing.*, user.*, order.*| Q4
    EX -->|*.completed, *.confirmed| Q5
    EX -->|notification.email| Q6
    EX -->|notification.push| Q7
        EX -->|# all events| Q8
    EX -->|*.created, *.updated, *.deleted| Q9

    %% Retry mechanisms
    Q1 -->|âŒ processing fails| Q1R
    Q1R -->|â° TTL expires| EX
    Q1R -->|ğŸ’€ max retries exceeded| Q1P
    
    Q2 -->|âŒ processing fails| Q2R
    Q2R -->|â° TTL expires| EX
    Q2R -->|ğŸ’€ max retries exceeded| Q2P
    
    Q3 -->|âŒ indexing fails| Q3R
    Q3R -->|â° TTL expires| EX
    
    Q4 -->|âŒ AI processing fails| Q4R
    Q4R -->|â° TTL expires| EX

    %% Dead letter routing
    Q1P --> DLX
    Q2P --> DLX

    %% Event Examples
    subgraph EventExamples["ğŸ“‹ Event Routing Examples"]
        E1["ğŸ“‹ listing.created<br/>â†’ listing.events.queue<br/>â†’ search.indexer.queue<br/>â†’ ai.recommendation.queue<br/>â†’ analytics.queue<br/>â†’ audit.queue"]
        E2["ğŸ’³ payment.completed<br/>â†’ order.events.queue<br/>â†’ notifications.queue<br/>â†’ analytics.queue"]
        E3["ğŸ›’ order.confirmed<br/>â†’ order.events.queue<br/>â†’ notifications.queue<br/>â†’ email.queue<br/>â†’ push.queue<br/>â†’ audit.queue"]
    end

    %% Queue Properties
    subgraph QueueConfig["âš™ï¸ Queue Configuration"]
        Config["ğŸ“‹ Standard Properties:<br/>â€¢ Durable: true<br/>â€¢ Auto-delete: false<br/>â€¢ Arguments:<br/>  - x-message-ttl: 300000 (5min)<br/>  - x-max-retries: 3<br/>  - x-dead-letter-exchange: domain.dlx<br/><br/>ğŸ” Monitoring:<br/>â€¢ Queue depth alerts<br/>â€¢ Consumer lag metrics<br/>â€¢ Dead letter tracking"]
    end

    %% Styling
    classDef exchange fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000;
    classDef queue fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000;
    classDef retry fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000;
    classDef poison fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000;
    classDef config fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000;
    
    class EX,DLX exchange;
    class Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9 queue;
    class Q1R,Q2R,Q3R,Q4R retry;
    class Q1P,Q2P poison;
    class Config config;
