%% PostgreSQL ERD for core relational entities
erDiagram
    USERS {
        UUID id PK "ğŸ”‘ Primary Key"
        VARCHAR email "ğŸ“§ Unique email address"
        VARCHAR password_hash "ğŸ” Bcrypt hash"
        VARCHAR first_name "ğŸ‘¤ First name"
        VARCHAR last_name "ğŸ‘¤ Last name"
        VARCHAR phone "ğŸ“± Phone number"
        TEXT[] roles "ğŸ­ User roles array"
        VARCHAR campus_id "ğŸ« University campus"
        BOOLEAN email_verified "âœ… Email verification"
        BOOLEAN phone_verified "âœ… Phone verification"
        JSONB preferences "âš™ï¸ User preferences"
        TIMESTAMP created_at "ğŸ“… Account creation"
        TIMESTAMP updated_at "ğŸ”„ Last update"
        TIMESTAMP last_login_at "ğŸ”“ Last login time"
    }
    
    PAYMENTS {
        UUID id PK "ğŸ”‘ Primary Key"
        UUID order_id "ğŸ“¦ Associated order"
        UUID buyer_id FK "ğŸ‘¤ Buyer reference"
        UUID seller_id FK "ğŸ‘¤ Seller reference"
        NUMERIC amount "ğŸ’° Payment amount (cents)"
        VARCHAR currency "ğŸ’± Currency code (ETB/USD)"
        VARCHAR status "ğŸ“Š Payment status"
        VARCHAR payment_method "ğŸ’³ Payment method"
        VARCHAR chapa_reference "ğŸ¦ Chapa transaction ID"
        VARCHAR webhook_signature "ğŸ” Webhook verification"
        JSONB metadata "ğŸ“‹ Additional payment data"
        TIMESTAMP initiated_at "â° Payment start time"
        TIMESTAMP completed_at "âœ… Payment completion"
        TIMESTAMP created_at "ğŸ“… Record creation"
        TIMESTAMP updated_at "ğŸ”„ Last update"
    }
    
    OUTBOX {
        UUID id PK "ğŸ”‘ Primary Key"
        UUID aggregate_id "ğŸ¯ Source aggregate ID"
        VARCHAR aggregate_type "ğŸ“ Aggregate type"
        VARCHAR event_type "ğŸ“¨ Event type"
        VARCHAR event_version "ğŸ”– Event schema version"
        JSONB payload "ğŸ“¦ Event payload"
        BOOLEAN published "âœ… Publication status"
        INTEGER retry_count "ğŸ”„ Retry attempts"
        TIMESTAMP created_at "ğŸ“… Event creation"
        TIMESTAMP published_at "ğŸ“¤ Publication time"
        TIMESTAMP next_retry_at "â° Next retry time"
    }
    
    AUDIT_LOG {
        UUID id PK "ğŸ”‘ Primary Key"
        UUID actor_id FK "ğŸ‘¤ Who performed action"
        VARCHAR action "ğŸ¬ Action performed"
        VARCHAR target_type "ğŸ¯ Target entity type"
        UUID target_id "ğŸ¯ Target entity ID"
        JSONB before_data "ğŸ“‹ Data before change"
        JSONB after_data "ğŸ“‹ Data after change"
        VARCHAR ip_address "ğŸŒ Client IP address"
        VARCHAR user_agent "ğŸ–¥ï¸ Client user agent"
        JSONB context "ğŸ“ Additional context"
        TIMESTAMP created_at "ğŸ“… Action timestamp"
    }
    
    PROCESSED_MESSAGES {
        VARCHAR message_id PK "ğŸ”‘ Message identifier"
        VARCHAR event_type "ğŸ“¨ Type of processed event"
        VARCHAR source_service "ğŸ—ï¸ Originating service"
        JSONB processing_result "ğŸ“Š Processing outcome"
        TIMESTAMP processed_at "âœ… Processing timestamp"
        TIMESTAMP expires_at "â° Cleanup timestamp"
    }
    
    USER_SESSIONS {
        UUID id PK "ğŸ”‘ Primary Key"
        UUID user_id FK "ğŸ‘¤ User reference"
        VARCHAR session_token "ğŸ« Session identifier"
        VARCHAR refresh_token "ğŸ”„ Refresh token"
        VARCHAR device_info "ğŸ“± Device information"
        VARCHAR ip_address "ğŸŒ Client IP"
        BOOLEAN is_active "âœ… Session status"
        TIMESTAMP expires_at "â° Session expiry"
        TIMESTAMP created_at "ğŸ“… Session start"
        TIMESTAMP last_used_at "ğŸ”„ Last activity"
    }
    
    WEBHOOK_LOGS {
        UUID id PK "ğŸ”‘ Primary Key"
        VARCHAR webhook_type "ğŸ£ Webhook type"
        VARCHAR source "ğŸª Webhook source (chapa, etc)"
        VARCHAR signature "ğŸ” Webhook signature"
        JSONB headers "ğŸ“‹ HTTP headers"
        JSONB payload "ğŸ“¦ Webhook payload"
        VARCHAR processing_status "ğŸ“Š Processing result"
        VARCHAR error_message "âŒ Error details"
        INTEGER retry_count "ğŸ”„ Retry attempts"
        TIMESTAMP received_at "ğŸ“¥ Webhook reception"
        TIMESTAMP processed_at "âœ… Processing completion"
    }

    %% Relationships with descriptive labels
    USERS ||--o{ PAYMENTS : "ğŸ‘¤ buyer/seller"
    USERS ||--o{ AUDIT_LOG : "ğŸ¬ performs actions"
    USERS ||--o{ USER_SESSIONS : "ğŸ”“ has sessions"
    
    %% Self-referencing and cross-references
    AUDIT_LOG }o--|| USERS : "ğŸ¯ tracks user actions"
    OUTBOX }o--|| USERS : "ğŸ“¨ user events"
    WEBHOOK_LOGS }o--o{ PAYMENTS : "ğŸ’³ payment webhooks"
