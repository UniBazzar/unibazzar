%% UniBazzar â€” AI Service Flow (FastAPI) flow: embeddings, vector DB, recommend endpoint
%% Author: UniBazzar-Team

sequenceDiagram
  autonumber
  participant L as ğŸ“‹ Listing Service
  participant I as ğŸ“¨ RabbitMQ Events
  participant AI as ğŸ¤– AI Service (FastAPI)
  participant ML as ğŸ§  ML Models
  participant VDB as ğŸ”® Vector Database
  participant CACHE as ğŸš€ Redis Cache
  participant ES as ğŸ” Elasticsearch
  participant API as ğŸŒ API Client

  Note over L,API: ğŸ¯ AI Service Complete Flow: Ingestion â†’ Processing â†’ Serving

  rect rgba(0, 0, 0)
    Note over L,VDB: ğŸ“ Content Ingestion & Processing
    L->>+I: ğŸ“¨ publish listing.created<br/>{id, title, description, category, images}
    I-->>+AI: ğŸ¯ listing.created event received
    
    AI->>+ML: ğŸ”¤ Generate text embeddings<br/>using sentence-transformers
    ML->>ML: ğŸ§  Process: title + description<br/>Model: all-MiniLM-L6-v2
    ML-->>-AI: âœ… Embedding vector [384 dimensions]
    
    AI->>+ML: ğŸ›¡ï¸ Content moderation check<br/>Text classification for safety
    ML->>ML: ğŸ” Analyze content for:<br/>â€¢ Inappropriate language<br/>â€¢ Spam patterns<br/>â€¢ Policy violations
    ML-->>-AI: âœ… Moderation result: {approved: true, confidence: 0.95}
    
    alt âœ… Content Approved
      AI->>+VDB: ğŸ’¾ Upsert vector<br/>collection: listings<br/>id: {listing_id}<br/>vector: [0.1, -0.3, ...]<br/>metadata: {category, campus, price}
      VDB-->>-AI: âœ… Vector stored successfully
      
      AI->>+CACHE: ğŸš€ Cache embedding metadata<br/>SET ai:embedding:{listing_id}<br/>TTL: 24h
      CACHE-->>-AI: âœ… Cached
      
      AI->>I: ğŸ“¨ publish listing.ai_processed<br/>{status: "approved", embedding_id}
      
    else ğŸš¨ Content Flagged
      AI->>I: ğŸ“¨ publish listing.content_flagged<br/>{reason: "inappropriate", confidence: 0.85}
      Note right of AI: Listing may be hidden<br/>pending manual review
    end
    deactivate AI
  end

  rect rgba(0, 0, 0)
    Note over API,CACHE: ğŸ” Real-time Recommendation Serving
    API->>+AI: ğŸ” GET /api/v1/recommendations<br/>?user_id=123&campus_id=main&limit=10
    
    AI->>+CACHE: ğŸš€ Check cache<br/>GET recommendations:user:123
    CACHE-->>-AI: ğŸ¯ Cache miss
    
    AI->>+VDB: ğŸ” Get user's interaction history<br/>Query similar vectors based on:<br/>â€¢ Previous views/likes<br/>â€¢ Category preferences<br/>â€¢ Price range patterns
    VDB-->>-AI: ğŸ“Š Similar listings: [id1, id2, id3...]<br/>with similarity scores
    
    AI->>+ML: ğŸ¯ Re-rank recommendations<br/>using hybrid approach:<br/>â€¢ Vector similarity (60%)<br/>â€¢ Popularity score (20%)<br/>â€¢ Recency bonus (20%)
    ML-->>-AI: ğŸ“ˆ Final ranked recommendations
    
    AI->>+CACHE: ğŸš€ Cache results<br/>SET recommendations:user:123<br/>TTL: 1h
    CACHE-->>-AI: âœ… Cached
    
    AI-->>-API: ğŸ“Š Recommendations response<br/>{items: [...], model_version: "1.2.3"}
  end

  rect rgba(0, 0, 0, 1)
    Note over AI,VDB: ğŸ”„ Batch Processing & Model Updates
    
    Note over AI: â° Scheduled Job: Daily Model Retraining
    AI->>+VDB: ğŸ“Š Export recent interaction data<br/>for model improvement
    VDB-->>-AI: ğŸ“ˆ Training data: user interactions,<br/>click-through rates, conversions
    
    AI->>+ML: ğŸ“ Retrain recommendation model<br/>â€¢ Update user embeddings<br/>â€¢ Adjust similarity weights<br/>â€¢ Fine-tune ranking algorithm
    ML-->>-AI: âœ… New model version: 1.2.4
    
    AI->>+CACHE: ğŸ§¹ Invalidate cached recommendations<br/>DEL recommendations:*
    CACHE-->>-AI: âœ… Cache cleared
    
    Note over AI: ğŸ”„ Model deployed, ready for inference
  end

  rect rgba(0, 0, 0, 1)
    Note over AI,ES: ğŸ” Smart Search Enhancement
    API->>+AI: ğŸ” POST /api/v1/search/semantic<br/>{query: "laptop for programming", campus_id, filters}
    
    AI->>+ML: ğŸ”¤ Generate query embedding<br/>from search text
    ML-->>-AI: âœ… Query vector [384]
    
    AI->>+VDB: ğŸ” Vector similarity search<br/>Find listings similar to query
    VDB-->>-AI: ğŸ“Š Vector matches: [ids with scores]
    
    AI->>+ES: ğŸ” Keyword search<br/>for exact term matching
    ES-->>-AI: ğŸ“‹ Text matches: [ids with scores]
    
    AI->>AI: ğŸ¯ Hybrid score fusion<br/>Combine vector + keyword results
    
    AI-->>-API: ğŸ” Enhanced search results<br/>{items, total, facets, suggestions}
  end

  Note over L,API: ğŸŠ AI Pipeline Complete: Content Safe â†’ Indexed â†’ Discoverable
