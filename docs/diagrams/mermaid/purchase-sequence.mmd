%% Purchase flow sequence (Order -> Reserve Stock -> Payment -> Confirm)
sequenceDiagram
  autonumber
  participant U as ğŸ›’ User (Mobile App)
  participant GW as ğŸšª API Gateway
  participant O as ğŸ“¦ Order Service
  participant L as ğŸ“‹ Listing Service
  participant P as ğŸ’³ Payment Service
  participant I as ğŸ“¨ RabbitMQ Events
  participant N as ğŸ“¢ Notification Service
  participant CHAPA as ğŸ’° Chapa Payment Gateway
  participant DB as ğŸ—„ï¸ Database Layer

  Note over U,DB: ğŸ¯ Complete Purchase Flow with Saga Pattern & Event Choreography
  
  U->>+GW: ğŸ›’ POST /orders<br/>{listing_id, qty, payment_method}
  GW->>+O: ğŸ“‹ CreateOrderCommand
  O->>DB: ğŸ’¾ Insert order (PENDING) + outbox event
  O->>-GW: ğŸ¯ Order created (ID: ORD-123)
  GW->>-U: âœ… Order initiated, proceed to payment
  
  Note over O,I: ğŸ”„ Asynchronous Event Choreography Begins
  O->>+I: ğŸ“¨ publish order.created
  
  par Stock Reservation Flow
    I-->>+L: ğŸ“‹ order.created â†’ reserve_stock
    L->>L: ğŸ” Validate stock availability
    alt âœ… Stock Available
      L->>DB: ğŸ”’ Reserve stock (atomic decrement)
      L->>I: ğŸ“¨ publish listing.stock_reserved
      Note right of L: Stock reserved for 15 minutes
    else âŒ Out of Stock
      L->>I: ğŸ“¨ publish order.rejected<br/>{reason: "out_of_stock"}
      I-->>O: ğŸš« order.rejected
      O->>DB: ğŸ’¾ Mark order CANCELLED
      O->>N: ğŸ“¢ notify_user_order_failed
    end
    deactivate L
    
  and Payment Initialization
    I-->>+P: ğŸ’³ order.created â†’ init_payment
    P->>P: ğŸ—ï¸ Create payment session
    P->>+CHAPA: ğŸ’° POST /api/v1/payment/initialize<br/>{amount, return_url, webhook_url}
    CHAPA-->>-P: ğŸ¯ Payment session created<br/>{checkout_url, reference}
    P->>DB: ğŸ’¾ Store payment record (PENDING)
    P->>I: ğŸ“¨ publish payment.initialized<br/>{checkout_url}
    deactivate P
  end
  
  I-->>U: ğŸ“± Push notification: "Complete your payment"
  
  Note over U,CHAPA: ğŸ”„ User Payment Flow (External)
  U->>+CHAPA: ğŸŒ Navigate to checkout_url
  CHAPA->>CHAPA: ğŸ’³ User completes payment<br/>(card/mobile money/bank)
  CHAPA-->>-U: âœ… Payment successful
  
  Note over P,CHAPA: ğŸ£ Webhook Processing (Async)
  CHAPA->>+P: ğŸ¯ POST /webhooks/chapa<br/>payment.succeeded event
  P->>P: âœ… Verify webhook signature
  P->>DB: ğŸ’¾ Update payment (COMPLETED) + outbox
  P->>I: ğŸ“¨ publish payment.completed<br/>{order_id, amount, reference}
  deactivate P
  
  Note over O,N: ğŸ‰ Order Completion Flow
  I-->>+O: ğŸ’° payment.completed
  O->>DB: ğŸ’¾ Mark order CONFIRMED<br/>Create transaction record
  O->>I: ğŸ“¨ publish order.confirmed
  deactivate O
  
  par Notifications
    I-->>+N: ğŸ“¢ order.confirmed â†’ notify_buyer
    N->>U: ğŸ“± Push: "Order confirmed! Seller will contact you"
    N->>U: ğŸ“§ Email: Order confirmation details
    deactivate N
  and Seller Notification  
    I-->>+N: ğŸ“¢ order.confirmed â†’ notify_seller
    N->>U: ğŸ“± Push: "New order received! Contact buyer"
    deactivate N
  end
  
  Note over U,DB: ğŸŠ Purchase Complete - Both parties notified
  
  rect rgb(255, 245, 245)
    Note over U,DB: ğŸš¨ Compensation Flow (if payment fails after stock reserved)
    alt Payment timeout or failure
      P->>I: ğŸ“¨ publish payment.failed
      I-->>L: ğŸ”„ payment.failed â†’ release_stock
      L->>DB: â†©ï¸ Release reserved stock
      I-->>O: âŒ payment.failed â†’ cancel_order
      O->>DB: ğŸ’¾ Mark order CANCELLED
    end
  end
